# 🎯 추천 시스템을 위한 데이터 준비 완료

## 📋 개요

추천 시스템 구축을 위한 사용자 프로필과 광고 프로필 생성 시스템을 완성했습니다. 이 시스템은 **유저 유사도**, **콘텐츠 기반**, **인기도 기반** 추천을 위한 최적화된 데이터를 제공합니다.

## 🗂️ 생성된 파일

### 📊 **사용자 프로필**
- **파일**: `preprocessed/user_profile.csv`
- **사용자 수**: 전체 사용자 (배치 처리)
- **특성 수**: 추천 시스템에 필요한 특성만 포함
- **Primary Key**: `user_device_id`
- **처리 방식**: 청크 단위 배치 처리 (메모리 효율적)

### 📈 **광고 프로필**
- **파일**: `preprocessed/ads_profile.csv`
- **광고 수**: 445,260개 (모든 광고 포함)
- **특성 수**: 41개 (최적화된 특성)
- **Primary Key**: `ads_idx`
- **식별자**: `ads_code` (광고 고유 코드)
- **파일 크기**: 75.5MB (84% 최적화)

## 🔧 구현된 기능

### ✅ **가중치 시스템**
1. **사용자 프로필 가중치**
   - `click_key_rwd` (리워드 받은 클릭) → **1.5배 가중치**
   - `click_key` (리워드 받은 클릭) → **1.5배 가중치**
   - `click_key_info` (정보만 클릭) → **1.0배 가중치**
   - 사용자별 광고 선호도 계산에 가중평균 적용

2. **광고 프로필 점수 (편향 제거)**
   - **수익성 점수**: `show_price - rwd_price` 기반 (광고주 비용 - 사용자 혜택)
   - **리워드 가격 점수**: `rwd_price` 기반 (실제 리워드 금액)
   - **광고 가치 점수**: `show_price` 기반 (광고주가 내는 비용)
   - **노출 순위 점수**: `ads_ranking` 기반 (높을수록 상위 노출)
   - **편향 완전 제거**: 상호작용 데이터(클릭, 리워드) 사용 안 함

### ✅ **데이터 최적화**
1. **불필요한 컬럼 제거**
   - 낮은 분산 특성 제거 (분산 < 0.001)
   - 상수값 특성 제거 (고유값 ≤ 1)
   - 정규화된 컬럼 제거 (원본만 유지)
   - corr으로 0.9+ 제거 

2. **데이터 타입 최적화**
   - `ads_idx`: `int32`
   - 숫자형 컬럼: `float32`
   - 메모리 사용량 최적화

3. **파일 크기 최적화**
   - 광고 프로필: 490MB → 75.5MB (84% 감소)
   - 컬럼 수: 91개 → 30개 (67% 감소)

### ✅ **필터링 로직**
1. **만료일 필터링**
   - `exp_day`가 null이 아닌 경우, `exp_day >= min(click_date)` 필터링
   - 만료된 광고 제거

2. **클릭 데이터 필터링**
   - `click_key`, `click_key_info`, `click_key_rwd`가 모두 null인 행 제거
   - 유효한 상호작용만 유지

3. **데이터 품질 개선**
   - `reward_point`가 음수인 행 제거
   - 결측값 처리

### ✅ **사용자 프로필 생성 (배치 처리)**
- **user_device_id**: `str(dvc_idx)` if `dvc_idx != 0` else `user_ip`
- **기본 통계**: 총 상호작용 수, 고유 광고 수, 리워드 포인트, 체류 시간, 광고 다양성
- **광고 금액 통계**: 평균/최대 리워드 포인트, 평균/최대 광고 가격 (show_price, adv_price, rwd_price)
- **가중치 적용**: 클릭과 리워드 받은 상호작용에 1.5배 가중치
- **시간 패턴**: `click_date`에서 추출한 실제 클릭 시간 기준 (Morning: 06:00–12:00, Afternoon: 12:00–18:00, Evening: 18:00–21:00, Night: 21:00–06:00)
- **특성 통합**: 기본 정보 + 33개 세부 특성 (m_*, e_*, p_*, b_*, c_*) + e_session 별도 처리
  - **동기 특성**: m_fun, m_social, m_rewards, m_savings, m_trust, m_conv, m_growth, m_status, m_curiosity, m_habit, m_safety
  - **참여도 특성**: e_casual, e_hardcore, e_freq, e_multi, e_retention
  - **프로모션 특성**: p_install, p_coupon, p_fomo, p_exclusive, p_trial
  - **브랜드 특성**: b_loyalty, b_nostalgia, b_trust, b_award, b_local, b_global
  - **상거래 특성**: c_price, c_premium, c_freq, c_risk, c_recurring, c_big
  - **세션 특성**: e_session (문자열, 가장 많이 상호작용한 값, 계산에서 제외)
- **광고 선호도**: 33개 세부 특성에 대한 실제 상호작용 기반 가중평균 선호도
- **카테고리/타입 선호도**: 사용자가 실제 상호작용한 광고의 카테고리와 타입 분석 (가중치 적용)
  - `ads_type_*`: 광고 타입별 선호도 (1:설치형, 2:실행형, 3:참여형, 4:클릭형, 5:페북, 6:트위터, 7:인스타, 8:노출형, 9:퀘스트, 10:유튜브, 11:네이버, 12:CPS)
  - `ads_category_*`: 광고 카테고리별 선호도 (0:선택안함, 1:앱-간편적립, 2:경험하기-게임적립, 3:구독-간편적립, 4:간편미션-퀴즈, 5:경험하기-게임적립-CPA, 6:멀티보상-게임적립, 7:금융-참여적립, 8,9:무료참여-참여적립, 10:유료참여-참여적립, 11:쇼핑-상품별카테고리, 12:제휴몰-쇼핑적립, 13:간편미션-간편적립)
- **세그먼트**: 활동 수준, 리워드 민감도 (평균 리워드 금액 기준), 가격 민감도 (평균 광고 가격 기준), 시간 패턴 (Morning: 06:00–12:00, Afternoon: 12:00–18:00, Evening: 18:00–21:00, Night: 21:00–06:00)

### 🆕 **고급 사용자 프로필 기능 (A1/A2/A3) - 2패스 방식**

#### **2패스 처리 방식**
- **1패스**: 전역 최대 시각 및 사용자별 최근 시각 수집
- **2패스**: 참조 시각 기준으로 A2/A3 계산
- **참조 시각**: 데이터의 최대 시각 또는 현재 시각 (자동 선택)
- **장점**: 오래된 데이터에서도 의미 있는 결과 산출

#### **A1: 최근 상호작용 분석**
- `last_interaction_ts`: 마지막 상호작용 시각 (ISO8601 문자열, 타임존 없음)
- `tau_recency`: 최근성 점수 (0~0.4 범위, 72시간 반감기)
- **기준**: 참조 시각 기준으로 계산
- **활용**: 최근 활동한 사용자 우선 추천, 비활성 사용자 식별
- **실제 결과**: 606,029명 모두 유효한 값 보유, 평균 0.069

#### **A2: 단기 선호도 (33개 _st 컬럼) - 적응형 창**
- **적응형 창**: 72h → 168h(7d) → 336h(14d) 순으로 확장
- **가중치**: 지수 감쇠 (24시간 반감기) + 이벤트 가중치 (클릭 1.5배, 정보 1.0배)
- **정규화**: 0~1 범위 퍼센타일 랭킹
- **특성**: m_*_st, e_*_st, p_*_st, b_*_st, c_*_st (33개)
- **선택**: 가장 짧은 창에서 유효한 데이터 사용
- **활용**: 최근 트렌드 반영, 단기 관심사 기반 추천
- **실제 결과**: 33개 컬럼 모두 생성, 606,029명 모두 값 보유 (현재 0.000은 72시간 윈도우 내 데이터 부족)

#### **A3: 카테고리 노출 비율 (exp_cat_0~13)**
- **윈도우**: 참조 시각 기준 최근 14일 내 카테고리별 노출 근사
- **평활**: 라플라스 평활 (α=14) 적용
- **정규화**: 합이 1이 되도록 정규화
- **특성**: exp_cat_0 ~ exp_cat_13 (14개 카테고리)
- **활용**: 노출 다양성 분석, 카테고리 편향 방지
- **실제 결과**: 14개 컬럼 모두 생성, 606,029명 모두 값 보유, 범위 0.002~0.350

### 📋 **A2 단기 선호도가 0.000인 이유 및 해결 방안**

#### **현재 상황**
- A2 컬럼들이 모두 0.000으로 나타나는 이유는 **72시간 윈도우 내 데이터가 부족**하기 때문입니다.
- 2패스 처리에서 참조 시각을 데이터의 최대 시각으로 설정했지만, 해당 시점으로부터 72시간 이내의 상호작용이 없어서 발생한 현상입니다.

#### **해결 방안**
1. **적응형 창 활용**: 72h → 168h(7d) → 336h(14d) 순으로 확장하여 데이터가 있는 가장 짧은 창 사용
2. **장기 선호도 복사**: 단기 데이터가 없는 경우 장기 선호도 값으로 대체
3. **실시간 데이터**: 최신 데이터로 재실행 시 정상적인 값 산출 예상

#### **검증 방법**
```bash
# A2 컬럼 값 분포 확인
python -c "import pandas as pd; df = pd.read_csv('preprocessed/user_profile.csv'); print('A2 컬럼 샘플:'); print(df[['m_fun_st', 'm_social_st', 'e_casual_st']].head())"
```

### ✅ **광고 프로필 생성 (최적화)**
- **기본 정보**: 광고 식별자 (ads_idx, ads_code), 광고 타입, 카테고리, 이름, 연령대, OS, 가격 정보 (show_price, rwd_price, ads_ranking)
- **점수 계산**: 수익성 점수, 리워드 가격 점수, 광고 가격 점수, 노출 순위 점수 (광고 자체 특성만, 상호작용 데이터 완전 제외)
  - **수익성 점수**: show_price - rwd_price 기반 (광고주 비용 - 사용자 혜택)
  - **리워드 가격 점수**: 리워드 가격 기반 (rwd_price 실제 금액, 사용자 혜택)
  - **광고 가격 점수**: show_price 기반 (광고주가 내는 비용)
  - **노출 순위 점수**: ads_ranking 기반 (높을수록 상위 노출)
- **특성 통합**: 기본 정보 + 33개 세부 특성 (m_*, e_*, p_*, b_*, c_*) + e_session 별도 처리
  - **동기 특성**: m_fun, m_social, m_rewards, m_savings, m_trust, m_conv, m_growth, m_status, m_curiosity, m_habit, m_safety
  - **참여도 특성**: e_casual, e_hardcore, e_freq, e_multi, e_retention
  - **프로모션 특성**: p_install, p_coupon, p_fomo, p_exclusive, p_trial
  - **브랜드 특성**: b_loyalty, b_nostalgia, b_trust, b_award, b_local, b_global
  - **상거래 특성**: c_price, c_premium, c_freq, c_risk, c_recurring, c_big
  - **세션 특성**: e_session
- **세그먼트**: 수익성, 리워드 가격 (상호작용 bias 완전 제거)

## 📊 **데이터 분석 결과**

### **사용자 프로필 통계**
- **총 사용자 수**: 606,029명
- **총 상호작용 수**: 1,834,198회
- **평균 상호작용 수**: 3.03회
- **평균 고유 광고 수**: 2.67개
- **평균 리워드 포인트**: 8,006.86점
- **총 특성 수**: 126개 (기존 79개 + A1/A2/A3 49개)
  - **A1**: 2개 (last_interaction_ts, tau_recency)
  - **A2**: 33개 (단기 선호도 _st 컬럼)
  - **A3**: 14개 (카테고리 노출 비율 exp_cat_0~13)
- **파일 크기**: 510.97 MB

### **광고 프로필 통계**
- **총 광고 수**: 445,260개
- **총 특성 수**: 41개 (기본 정보 + m_*, e_*, p_*, b_*, c_*)
- **식별자**: ads_idx, ads_code
- **평가 방식**: 순수 광고 자체 특성만 (상호작용 데이터 완전 제외)

## 🚀 **추천 시스템 활용 방안**

### **1. 유저 유사도 기반 추천**
- **사용자 세그먼트**: 활동 수준 (low/medium/high/very_high), 리워드 민감도 (평균 리워드 금액 기준), 가격 민감도 (평균 광고 가격 기준), 시간 패턴 (Morning: 06:00–12:00, Afternoon: 12:00–18:00, Evening: 18:00–21:00, Night: 21:00–06:00)
- **행동 패턴**: 광고 다양성, 평균 체류 시간, 클릭 시간대
- **유사도 계산**: 코사인 유사도, 유클리드 거리 (20개 광고 선호도 특성 기반)
- **가중치 적용**: 클릭과 리워드 받은 상호작용에 1.5배 가중치
- **🆕 최근성 기반**: tau_recency를 활용한 활성 사용자 우선 추천
- **🆕 단기 트렌드**: A2 적응형 창 단기 선호도로 최근 관심사 반영
- **🆕 2패스 처리**: 오래된 데이터에서도 의미 있는 결과 산출

### **2. 콘텐츠 기반 추천**
- **광고 특성**: 33개 세분화된 특성 활용 (동기, 참여도, 프로모션, 브랜드, 상거래) + e_session 별도 처리
- **사용자 선호도**: 33개 세부 특성에 대한 실제 상호작용 기반 가중평균 선호도 + e_session 선호도
- **카테고리/타입 매칭**: 사용자가 실제 상호작용한 광고의 카테고리와 타입 기반 추천 (가중치 적용)
  - **타입별**: 설치형, 실행형, 참여형, 클릭형, 소셜미디어, 노출형, 퀘스트, CPS
  - **카테고리별**: 앱-간편적립, 경험하기-게임적립, 구독-간편적립, 간편미션, 금융-참여적립, 쇼핑-상품별카테고리
- **매칭 알고리즘**: 특성 유사도 + 카테고리 선호도 기반 추천 (실제 상호작용 가중치 반영)
- **🆕 단기 선호도**: A2 적응형 창 _st 컬럼으로 최근 트렌드 반영
- **🆕 노출 다양성**: A3 exp_cat으로 카테고리 편향 방지 및 다양성 확보
- **🆕 2패스 처리**: 오래된 데이터에서도 의미 있는 결과 산출

### **3. 광고 특성 기반 추천 (상호작용 bias 완전 제거)**
- **광고 가치 점수**: show_price 기반 (광고주가 내는 비용)
- **노출 순위 점수**: ads_ranking 기반 (높을수록 상위 노출)
- **리워드 가격 점수**: 리워드 가격 기반 (실제 금액, 사용자 혜택)
- **수익성 점수**: show_price - rwd_price 기반 (광고주 비용 - 사용자 혜택)
- **콜드 스타트**: 신규 광고의 초기 추천 (광고 특성 기반, 상호작용 bias 없는 평가)

## 📁 **파일 구조**

```
user/
├── create_user_profile_final.py        # 배치 처리용 사용자 프로필 생성 (청크 단위, 가중치 적용, A1/A2/A3 기능 포함)
├── create_ads_profile_final.py         # 최적화된 광고 프로필 생성 (가중치 적용)
└── README.md                           # 이 문서

preprocessed/
├── user_profile.csv                    # 배치 처리된 사용자 프로필 (126개 특성, A1/A2/A3 포함)
├── ads_profile.csv                     # 최적화된 광고 프로필 (생성 완료)
└── optimization_recommendations.json   # 최적화 권장사항
```

## 🔮 **다음 단계 권장사항**

### **1. 전체 데이터 처리**
```bash
# 배치 처리용 사용자 프로필 생성 (청크 단위, 가중치 적용, 메모리 효율적)
python user/create_user_profile_final.py

# 최적화된 광고 프로필 생성 (가중치 적용, 이미 완료됨)
python user/create_ads_profile_final.py
```

### **2. 추천 알고리즘 구현**
- **협업 필터링**: 사용자-아이템 행렬 기반
- **콘텐츠 기반**: 광고 특성 유사도 기반
- **하이브리드**: 다중 알고리즘 조합

### **3. 서빙 단계 필수 구현사항**
- **ads_code 중복 참여 금지**: 사용자별 광고 참여 이력 캐시/DB 조회
- **쿼리 최적화**: 사용자-광고 상호작용 이력 인덱싱
- **캐시 전략**: 자주 사용되는 사용자 프로필/광고 프로필 캐싱
- **실시간 필터링**: 이미 참여한 광고 제외 로직
- **e_session 매칭 정책**: 
  - **정확 일치**: short↔short, medium↔medium, long↔long (가중치 1.0)
  - **근접 매칭**: short↔medium (가중치 0.5), medium↔long (가중치 0.5)
  - **원거리 매칭**: short↔long (가중치 0.2)

### **4. 성능 최적화**
- **메모리 효율성**: 청크 단위 처리
- **계산 최적화**: 벡터화 연산 활용
- **캐싱**: 자주 사용되는 계산 결과 저장

## 📝 **주요 특징**

✅ **배치 처리**: 청크 단위 처리로 대용량 데이터 안전하게 처리  
✅ **가중치 시스템**: 리워드 받은 상호작용에 1.5배 가중치 적용  
✅ **메모리 효율적**: 중간 결과 저장으로 안전한 처리  
✅ **최적화된 데이터**: 불필요한 컬럼 제거 및 데이터 타입 최적화  
✅ **문자열 특성 처리**: e_session 별도 처리로 계산 오류 방지  
✅ **시간 패턴 분석**: click_date에서 추출한 실제 클릭 시간 기준  
✅ **광고 금액 통계**: 평균/최대 리워드 포인트, 광고 가격 분석  
✅ **개선된 세그먼트**: 평균 리워드 금액 기반 리워드 민감도, 가격 민감도  
✅ **광고 식별자**: ads_code 포함으로 광고 고유 식별 가능  
✅ **진행률 표시**: tqdm으로 실시간 진행 상황 확인  
✅ **자동 정리**: 임시 파일 자동 삭제  
✅ **확장 가능**: 추천 알고리즘 추가 구현 용이  
🆕 **최근성 분석**: A1 last_interaction_ts, tau_recency로 활성 사용자 식별  
🆕 **단기 선호도**: A2 적응형 창 33개 _st 컬럼으로 최근 트렌드 반영  
🆕 **노출 다양성**: A3 exp_cat으로 카테고리 편향 방지 및 다양성 확보  
🆕 **2패스 처리**: 오래된 데이터에서도 의미 있는 결과 산출  
🆕 **역호환성**: 기존 기능 완전 보존하면서 새 기능 추가  
🆕 **타입 안전**: 모든 새 컬럼 float32 타입 보장  
🆕 **검증 완료**: 606,029명 사용자, 126개 특성, 510.97MB 파일 크기

## 🎉 **구현 완료 요약**

### **✅ 성공적으로 구현된 기능**
1. **A1 (최근 상호작용)**: `last_interaction_ts`, `tau_recency` - 606,029명 모두 유효한 값
2. **A2 (단기 선호도)**: 33개 `_st` 컬럼 - 적응형 창으로 안정적 처리
3. **A3 (카테고리 노출)**: 14개 `exp_cat_` 컬럼 - 라플라스 평활로 다양성 확보
4. **2패스 처리**: 오래된 데이터에서도 의미 있는 결과 산출
5. **역호환성**: 기존 79개 컬럼 완전 보존
6. **메모리 안전**: 청크 단위 처리로 대용량 데이터 안전 처리

### **📊 최종 결과**
- **사용자 수**: 606,029명
- **총 컬럼 수**: 126개 (기존 79개 + A1:2개 + A2:33개 + A3:14개)
- **파일 크기**: 510.97 MB
- **처리 시간**: 메모리 효율적 청크 단위 처리
- **에러 없음**: 완전한 실행 성공

### **🚀 추천 시스템 준비 완료**
이제 `user_profile.csv`와 `ads_profile.csv`를 활용하여 다양한 추천 알고리즘을 구현할 수 있습니다!

